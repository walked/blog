<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>PowerShell DSC - cDscDocker - Version 1.1.0 - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="PowerShell DSC - cDscDocker - Version 1.1.0" />
<meta property="og:description" content="Now with docker swarm support!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2016-11-2-cdscdocker110/" />
<meta property="article:published_time" content="2016-11-02T12:32:30-05:00" />
<meta property="article:modified_time" content="2016-11-02T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PowerShell DSC - cDscDocker - Version 1.1.0"/>
<meta name="twitter:description" content="Now with docker swarm support!"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">PowerShell DSC - cDscDocker - Version 1.1.0</h1>
			<div class="meta">Posted on &mdash; Nov 2, 2016</div>
		</div>

		<div class="markdown">
			<p>Now with docker swarm support!</p>
<p>First up; the links: 
PowerShell Gallery: <a href="https://www.powershellgallery.com/packages/cDscDocker/1.1.0">https://www.powershellgallery.com/packages/cDscDocker/1.1.0</a> 
GitHub: <a href="https://github.com/walked/cDscDocker">https://github.com/walked/cDscDocker</a></p>
<p>First off; a new example DSC Configuration</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Configuration dockerConfig
{
    <span style="color:#b58900">Import-DscResource</span> -module cDscDocker

    Node localhost{

    LocalConfigurationManager
    {
        RebootNodeIfNeeded = <span style="color:#268bd2">$true</span>
    }
        cDscDocker test
        {
            docker = <span style="color:#2aa198">&#34;docker&#34;</span> <span style="color:#586e75">#key; mandatory</span>
            Ensure = <span style="color:#2aa198">&#39;Present&#39;</span> <span style="color:#586e75">#mandatory field (Available options: Present, Absent)</span>
            swarm = <span style="color:#2aa198">&#39;Active&#39;</span> <span style="color:#586e75">#mandatory field (Available options: Active, Inactive)</span>
            swarmToken = <span style="color:#2aa198">&#34;SWMTKN-1-guidguidguidguidguidguidguidguid&#34;</span> <span style="color:#586e75">#your swarm token here</span>
            swarmURI = <span style="color:#2aa198">&#34;192.168.1.100:2377&#34;</span> <span style="color:#586e75">#IP address of manager node</span>

        }
    }
}

dockerConfig
</code></pre></div><p>Hm&hellip; let&rsquo;s look at what we have (that&rsquo;s new) here:</p>
<p><strong>Ensure:</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">Ensure = &#39;Present&#39;
</code></pre></div><p><em>This is for the state of docker; Present means docker is installed; Absent means it&rsquo;s not.</em></p>
<p><strong>swarm:</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">swarm = &#39;Active&#39;
</code></pre></div><p><em>This is the property that identifies whether docker should be a swarm member.</em></p>
<p><strong>swarmToken, swarmURI:</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">swarmToken = &#34;SWMTKN-1-guidguidguidguidguidguidguidguid&#34; #your swarm token here
swarmURI = &#34;192.168.1.100:2377&#34; #IP address of manager node
</code></pre></div><p><em>These are only evaluated if the swarm state is set to active, but the DSC configuration manager shows it is not. Please note that changing this token or URI will <strong>not</strong> change a swarm membership if is already a member of a swarm. I still need to find some way to do better docker swarm introspection for that.</em>  </p>
<p>All in all; <em>in my lab</em> this is testing great. There are some corner cases where if a reboot is pending for docker installed outside of the control of DSC (e.g. get-service shows docker is installed, but it&rsquo;s still needing a reboot), it can fail not so gracefully. I&rsquo;m going to work on making sure that doesnt happen in the next release or two.  </p>
<p>Full code:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">enum Ensure
{
	Present
	Absent
}

enum Swarm
{
	Active
	Inactive
}

[DscResource()]
class cDscDocker 
{
	[DscProperty(Key)] 
	<span style="color:#cb4b16">[string]</span><span style="color:#268bd2">$docker</span>

	[DscProperty(<span style="color:#719e07">Mandatory</span>)] 
	<span style="color:#cb4b16">[Ensure]</span><span style="color:#268bd2">$Ensure</span>

	[DscProperty()]
	<span style="color:#cb4b16">[string]</span><span style="color:#268bd2">$swarmToken</span>

	[DscProperty()]
	<span style="color:#cb4b16">[string]</span><span style="color:#268bd2">$swarmURI</span>

	[DscProperty(<span style="color:#719e07">Mandatory</span>)]
	<span style="color:#cb4b16">[Swarm]</span><span style="color:#268bd2">$swarm</span>

	<span style="color:#586e75">#Equivalent of Set-TargetResource</span>
	<span style="color:#586e75">#Executes the current operation necessary to get the system to the desired state</span>
	<span style="color:#cb4b16">[void]</span> Set()
	{
		<span style="color:#268bd2">$dockerProviderAvailable</span> = <span style="color:#268bd2">$this</span>.CheckDockerProvider()
		<span style="color:#268bd2">$dockerInstalled</span> = <span style="color:#268bd2">$this</span>.CheckDocker()
		<span style="color:#268bd2">$dockerInSwarm</span> = <span style="color:#268bd2">$this</span>.CheckDockerSwarm()
		<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Settings&#34;</span>
		<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker </span>$(<span style="color:#268bd2">$this</span>.Ensure)<span style="color:#2aa198">&#34;</span>
		<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Swarm </span>$(<span style="color:#268bd2">$this</span>.swarm)<span style="color:#2aa198">&#34;</span>

		<span style="color:#719e07">switch</span>(<span style="color:#268bd2">$this</span>.Ensure)
		{
			Present{
				<span style="color:#719e07">if</span>(<span style="color:#719e07">-not</span> <span style="color:#268bd2">$dockerProviderAvailable</span>)
				{
					<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker Provider not Available; Installing Provider&#34;</span>
					<span style="color:#268bd2">$this</span>.InstallDockerProvider()
				}

				<span style="color:#719e07">if</span>(<span style="color:#719e07">-not</span> <span style="color:#268bd2">$dockerInstalled</span>)
				{
					<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker not installed; installing docker&#34;</span>
					<span style="color:#268bd2">$this</span>.InstallDocker()
				}

				<span style="color:#719e07">if</span>(<span style="color:#268bd2">$global:DSCMachineStatus</span> <span style="color:#719e07">-ne</span> 1)
				{
					<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Not pending reboot&#34;</span>
					<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Entering Switch&#34;</span>
					<span style="color:#719e07">switch</span>(<span style="color:#268bd2">$this</span>.swarm)
					{

						Active{
							<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Setting Swarm to Active&#34;</span>
							<span style="color:#719e07">if</span>(<span style="color:#719e07">-not</span> <span style="color:#268bd2">$dockerInSwarm</span>){
								<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Not in docker swarm; executing join method&#34;</span>
								<span style="color:#268bd2">$this</span>.JoinDockerSwarm()
							}

						}
						Inactive{
							<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Setting swarm to inactive&#34;</span>
							<span style="color:#719e07">if</span>(<span style="color:#268bd2">$dockerInSwarm</span>){
								<span style="color:#268bd2">$this</span>.LeaveDockerSwarm()
							}

						}
					}
				}

			}
			Absent{
				<span style="color:#719e07">if</span>(<span style="color:#268bd2">$dockerInSwarm</span>){
					<span style="color:#268bd2">$this</span>.LeaveDockerSwarm()
				}
				<span style="color:#719e07">if</span>(<span style="color:#268bd2">$dockerInstalled</span>){
					<span style="color:#268bd2">$this</span>.UninstallDocker()
				}

			}
		}

	}

	<span style="color:#586e75">#Equivalent of Test-TargetResource</span>
	<span style="color:#586e75">#Returns true if system is in the state specified; false if a modification needs to take place</span>
	<span style="color:#cb4b16">[bool]</span> Test()
	{
		<span style="color:#268bd2">$objectValidState</span> = <span style="color:#268bd2">$false</span>
		<span style="color:#268bd2">$dockerPresent</span> = <span style="color:#268bd2">$this</span>.CheckDocker()
		<span style="color:#719e07">if</span>(<span style="color:#268bd2">$dockerPresent</span>)
		{
			<span style="color:#268bd2">$dockerSwarm</span> = <span style="color:#268bd2">$this</span>.CheckDockerSwarm()
		}
		<span style="color:#719e07">else</span>
		{
			<span style="color:#268bd2">$dockerSwarm</span> = <span style="color:#268bd2">$false</span>
		}

		<span style="color:#719e07">if</span> (<span style="color:#268bd2">$this</span>.Ensure <span style="color:#719e07">-eq</span> <span style="color:#cb4b16">[Ensure]</span>::Present)
		{

			<span style="color:#719e07">if</span> (<span style="color:#268bd2">$dockerPresent</span>)
			{

				<span style="color:#719e07">if</span>(<span style="color:#268bd2">$this</span>.swarm <span style="color:#719e07">-eq</span> <span style="color:#cb4b16">[Swarm]</span>::Active)
				{
					<span style="color:#719e07">if</span>(<span style="color:#268bd2">$dockerSwarm</span> <span style="color:#719e07">-eq</span> <span style="color:#268bd2">$true</span>)
					{
						<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker is present (Expect: Present). Swarm is Active (Expect: Active). VALID STATE&#34;</span>
						<span style="color:#268bd2">$objectValidState</span> = <span style="color:#268bd2">$true</span>;
					}

					<span style="color:#719e07">if</span>(<span style="color:#268bd2">$dockerSwarm</span> <span style="color:#719e07">-eq</span> <span style="color:#268bd2">$false</span>)
					{
						<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker is present (Expect: Present). Swarm is Inactive (Expect: Active). INVALID STATE&#34;</span>
						<span style="color:#719e07">return</span> <span style="color:#268bd2">$false</span>;
					}
				}
				<span style="color:#719e07">elseif</span>(<span style="color:#268bd2">$this</span>.swarm <span style="color:#719e07">-eq</span> <span style="color:#cb4b16">[Swarm]</span>::Inactive)
				{
					<span style="color:#719e07">if</span>(<span style="color:#268bd2">$dockerSwarm</span> <span style="color:#719e07">-eq</span> <span style="color:#268bd2">$true</span>)
					{
						<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker is present (Expect: Present). Swarm is Active (Expect: Inactive). INVALID STATE&#34;</span>
						<span style="color:#719e07">return</span> <span style="color:#268bd2">$false</span>;
					}
					<span style="color:#719e07">elseif</span>(<span style="color:#268bd2">$dockerSwarm</span> <span style="color:#719e07">-eq</span> <span style="color:#268bd2">$false</span>)
					{
						<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker is present (Expect: Present). Swarm is Inactive (Expect: Inactive). VALID STATE&#34;</span>
						<span style="color:#268bd2">$objectValidState</span> = <span style="color:#268bd2">$true</span>
					}
				}

				<span style="color:#586e75">#Fallback; setting this item in case return route is missed</span>
				<span style="color:#268bd2">$objectValidState</span> = <span style="color:#268bd2">$true</span>

			}

			<span style="color:#719e07">if</span> (<span style="color:#719e07">-not</span> <span style="color:#268bd2">$dockerPresent</span>)
			{
				<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker is Absent (Expect: Present). INVALID STATE&#34;</span>
				<span style="color:#719e07">return</span> <span style="color:#268bd2">$false</span>
			}
		}
		<span style="color:#719e07">Else</span>
		{
			<span style="color:#719e07">if</span> (<span style="color:#268bd2">$dockerPresent</span>)
			{
				<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker is Present (Expect: Absent). INVALID STATE&#34;</span>
				<span style="color:#719e07">return</span> <span style="color:#268bd2">$false</span>
			}
			<span style="color:#719e07">if</span> (<span style="color:#719e07">-not</span> <span style="color:#268bd2">$dockerPresent</span>)
			{
				<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Docker is Absent (Expect: Absent). VALID STATE&#34;</span>
				<span style="color:#268bd2">$objectValidState</span> = <span style="color:#268bd2">$true</span>
			}

		}

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$objectValidState</span>

	}

	<span style="color:#586e75">#Equivalent of the Get-TargetResource</span>
	<span style="color:#586e75">#Get&#39;s the current state of the system in cDscDocker object form</span>
	<span style="color:#cb4b16">[cDscDocker]</span> Get()
	{
		<span style="color:#719e07">if</span> (<span style="color:#268bd2">$this</span>.CheckDocker())
		{
			<span style="color:#268bd2">$this</span>.Ensure = <span style="color:#cb4b16">[Ensure]</span>::Present
		}
		<span style="color:#719e07">else</span>
		{
			<span style="color:#268bd2">$this</span>.Ensure = <span style="color:#cb4b16">[Ensure]</span>::Absent
		}

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$this</span>

	}

	<span style="color:#586e75">#Swarm Action, join</span>
	<span style="color:#cb4b16">[void]</span>JoinDockerSwarm()
	{
		<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Joining Docker Swarm&#34;</span>
		docker swarm join --token $(<span style="color:#268bd2">$this</span>.swarmToken) $(<span style="color:#268bd2">$this</span>.swarmURI)

	}

	<span style="color:#586e75">#Swarm action, leave</span>
	<span style="color:#cb4b16">[void]</span>LeaveDockerSwarm()
	{
		docker swarm leave --force
	}

	<span style="color:#cb4b16">[bool]</span>CheckDockerSwarm()
	{
		<span style="color:#268bd2">$returnValue</span> = <span style="color:#268bd2">$false</span>

		<span style="color:#719e07">if</span>(<span style="color:#268bd2">$this</span>.CheckDocker()){
			<span style="color:#268bd2">$info</span> = docker info
			<span style="color:#719e07">foreach</span>(<span style="color:#268bd2">$item</span> <span style="color:#719e07">in</span> <span style="color:#268bd2">$info</span>)
			{
				<span style="color:#719e07">if</span>(<span style="color:#268bd2">$item</span> <span style="color:#719e07">-match</span> <span style="color:#2aa198">&#34;swarm&#34;</span>)
				{
					<span style="color:#719e07">if</span>(<span style="color:#268bd2">$item</span> <span style="color:#719e07">-match</span> <span style="color:#2aa198">&#34;\sactive&#34;</span>)
					{
						<span style="color:#719e07">return</span> <span style="color:#268bd2">$true</span>
					}
					<span style="color:#719e07">elseif</span>(<span style="color:#268bd2">$item</span> <span style="color:#719e07">-match</span> <span style="color:#2aa198">&#34;inactive&#34;</span>)
					{
						<span style="color:#719e07">return</span> <span style="color:#268bd2">$false</span>
					}
				}
			}
		}

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$returnValue</span>
	}
	<span style="color:#586e75">#Docker Action, Verify</span>
	<span style="color:#cb4b16">[bool]</span>CheckDocker()
	{
        <span style="color:#268bd2">$installed</span> = <span style="color:#268bd2">$false</span>

        <span style="color:#719e07">if</span>(<span style="color:#268bd2">$this</span>.CheckDockerProvider())
        {

		    <span style="color:#268bd2">$packages</span> = <span style="color:#b58900">Get-Package</span> -ProviderName DockerMsftProvider
		    <span style="color:#719e07">foreach</span> (<span style="color:#268bd2">$p</span> <span style="color:#719e07">in</span> <span style="color:#268bd2">$packages</span>)
		    {
			    <span style="color:#719e07">if</span> (<span style="color:#268bd2">$p</span>.Name <span style="color:#719e07">-eq</span> <span style="color:#2aa198">&#39;docker&#39;</span>)
			    {
				    <span style="color:#268bd2">$installed</span> = <span style="color:#268bd2">$true</span>
			    }
		    }

			<span style="color:#586e75">#In case this was installed as a service via other means; e.g. not the DockerMsftProvider</span>
			<span style="color:#268bd2">$services</span> = <span style="color:#b58900">Get-Service</span> | <span style="color:#b58900">Where-Object</span> {<span style="color:#268bd2">$_</span>.Name <span style="color:#719e07">-like</span> <span style="color:#2aa198">&#34;docker&#34;</span>}
			<span style="color:#719e07">if</span> (<span style="color:#268bd2">$services</span>.Length )
			{
				<span style="color:#268bd2">$installed</span> = <span style="color:#268bd2">$true</span>
			}
        }

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$installed</span>
	}

	<span style="color:#586e75">#Docker Action, Install</span>
	<span style="color:#cb4b16">[void]</span>InstallDocker()
	{
		<span style="color:#b58900">Install-Package</span> -Name docker -ProviderName DockerMsftProvider -Force
		<span style="color:#268bd2">$global:DSCMachineStatus</span> = 1
	}

	<span style="color:#586e75">#Docker Action, Uninstall</span>
	<span style="color:#cb4b16">[void]</span>UninstallDocker()
	{
		<span style="color:#b58900">Uninstall-Package</span> -ProviderName DockerMsftProvider -Name docker -Force <span style="color:#586e75">#Uninstall docker; will move to a function if re-used elsewhere</span>
	}

	<span style="color:#586e75">#Docker Provider Action; verify</span>
	<span style="color:#cb4b16">[bool]</span>CheckDockerProvider()
	{
		<span style="color:#268bd2">$available</span> = <span style="color:#268bd2">$false</span>
		<span style="color:#268bd2">$providers</span> = <span style="color:#b58900">Get-PackageProvider</span> -ListAvailable

		<span style="color:#719e07">foreach</span>(<span style="color:#268bd2">$provider</span> <span style="color:#719e07">in</span> <span style="color:#268bd2">$providers</span>)
        {
		    <span style="color:#719e07">if</span> (<span style="color:#268bd2">$provider</span>.Name <span style="color:#719e07">-eq</span> <span style="color:#2aa198">&#34;DockerMsftProvider&#34;</span>)
		    {
			    <span style="color:#268bd2">$available</span> = <span style="color:#268bd2">$true</span>
		    }
        }

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$available</span>
	}

	<span style="color:#586e75">#Docker Provider Action; install</span>
	<span style="color:#cb4b16">[void]</span>InstallDockerProvider()
	{
		<span style="color:#b58900">Install-Module</span> -Name DockerMsftProvider -Repository psgallery -Force
	}

}


</code></pre></div>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/docker">docker</a></li>
								
								<li><a href="/tags/windows">windows</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright © - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
