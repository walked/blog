<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Jekyll, Jenkins, and CI - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Jekyll, Jenkins, and CI" />
<meta property="og:description" content="Hey guys; as I mentioned - I wanted to come back to run through the workflow I have setup for this blog, CI, and source control!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2017-01-22-ci-and-this-blog/" />
<meta property="article:published_time" content="2017-01-22T12:32:30-05:00" />
<meta property="article:modified_time" content="2017-01-22T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Jekyll, Jenkins, and CI"/>
<meta name="twitter:description" content="Hey guys; as I mentioned - I wanted to come back to run through the workflow I have setup for this blog, CI, and source control!"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Jekyll, Jenkins, and CI</h1>
			<div class="meta">Posted on &mdash; Jan 22, 2017</div>
		</div>

		<div class="markdown">
			<p>Hey guys; as I mentioned - I wanted to come back to run through the workflow I have setup for this blog, CI, and source control!</p>
<p>[So, as I referenced before:]({{ site.baseurl }}{% post_url 2017-01-17-hosted-on-aws %}) I&rsquo;ve moved this blog from WordPress / Shared Hosting, to AWS/S3/Cloudfront.</p>
<p>As a part of that, I also revamped my blog publishing workflow and it&rsquo;s been great!</p>
<h3 id="the-components">The components:</h3>
<ol>
<li>
<p>The blog is build flat-file using Jekyll; Jekyll is more or less a sorta-compiler of sorts that parses style sheets, templates, markdown posts, and asset directories (think images) and compiles it into a nicely formatted flat-file blog, so no server side processing is needed (that all happens at build) and we can use S3 for backend storage, minimize the surface-area of our application, and take advantage of CloudFront. Awesome.</p>
</li>
<li>
<p>The code (markdown files, templates, etc) are stored in git (namely, CodeCommit for me)</p>
</li>
<li>
<p>The build is handled via Jenkins; which has a staging build and a production build. Each performs some transforms and pushes to an S3 bucket accordingly.</p>
</li>
</ol>
<h3 id="jekyll">Jekyll:</h3>
<p>First off, I&rsquo;m not going to run through Jekyll in depth. It&rsquo;s pretty quick to pick up. Whats worth noting is on the Jekyll host there are two main commands to know:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">jekyll build
</code></pre></div><p>and</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">jekyll serve 
</code></pre></div><p>Build will simply compile the site into a publishable directory, whereas serve will actually serve the code on a development webserver for testing.</p>
<h3 id="jenkins">Jenkins:</h3>
<p>This is where it&rsquo;s a bit cooler.</p>
<p>Let&rsquo;s look at my staging job (which is pretty much exactly the same as my production job)</p>
<p><strong>Quick Summary of the Jenkins Job</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">General:
├─ Project Name: publish-blog-staging
├─ ☑ Restrict where this project can be run
│     └─ Label Expression: jekyll
│
Source Code Management&#34;
├─ ☑ Git
│     ├─ Repository URL: ssh://git-codecommit.us-east-1.amazonaws.com/v1/repos/etcetcetc
│     └─ Branches to build: */staging
│
Build Tiggers:
├─ ☑ Poll SCM
│     └─ Schedule: H/30 * * * *
│
Build Environment:
├─ ☑ Delete workspace before build starts
│
Build:
├─ Execute Shell:  
│     ├─ python3 $WORKSPACE/transform.py --domain=&#34;staging.i-py.com&#34; --protocol=&#34;http&#34;
│     └─ ~/build-jenkins.bat
│
Post Build Actions:
└─ Publish artifacts to S3 buckets:  
      ├─ Source: _site/**
      ├─ Destination bucket: bucket.domain.com (intentionally generic)
      └─ ☑ No upload on build failure
</code></pre></div><p>Ok cool. Short and sweet summary:</p>
<ol>
<li>We poll git every 30min; for this project we check the staging branch</li>
<li>If a change is detected, it triggers a build.</li>
<li>It will clean up the environment workspace prior to build (as we dont have any reason to keep around previous builds)</li>
<li>The build executes two shell statements:
<ol>
<li><code>python3 $WORKSPACE/transform.py</code> is a custom transform script I wrote. It will take a domain and protocol argument and edit the Jekyll _Config.yml file prior to build (as my staging site is <a href="http://staging.i-py.com">http://staging.i-py.com</a> I want Jekyll to reflect that on build)</li>
<li><code>~/build-jenkins.bat</code> is a super simple script that effectively just calls the <code>jekyll build</code> command</li>
</ol>
</li>
<li>The site is then uploaded to my Staging S3 bucket (which is where I have my staging site pointed to)</li>
</ol>
<p>Boom!</p>
<p>Let&rsquo;s look at what my <code>transform.py</code> script does:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#719e07">import</span> argparse<span style="color:#719e07">,</span> sys<span style="color:#719e07">,</span> os

parser <span style="color:#719e07">=</span> argparse<span style="color:#719e07">.</span>ArgumentParser()
cwd <span style="color:#719e07">=</span> os<span style="color:#719e07">.</span>getcwd()
configFile <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;_config.yml&#34;</span>

add_arg <span style="color:#719e07">=</span> parser<span style="color:#719e07">.</span>add_argument
add_arg(<span style="color:#2aa198">&#34;-d&#34;</span>,   <span style="color:#2aa198">&#34;--domain&#34;</span>,  default<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;i-py.com&#34;</span>,   help<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;deployment domain&#34;</span>)
add_arg(<span style="color:#2aa198">&#34;-p&#34;</span>,     <span style="color:#2aa198">&#34;--protocol&#34;</span>,     default<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;http&#34;</span>,   help<span style="color:#719e07">=</span><span style="color:#2aa198">&#34;site protocol&#34;</span>)
args <span style="color:#719e07">=</span> parser<span style="color:#719e07">.</span>parse_args()

<span style="color:#719e07">if</span> <span style="color:#b58900">len</span>(sys<span style="color:#719e07">.</span>argv) <span style="color:#719e07">&gt;</span> <span style="color:#2aa198">1</span>:
   <span style="color:#719e07">print</span>(args<span style="color:#719e07">.</span>domain)
   <span style="color:#719e07">print</span>(args<span style="color:#719e07">.</span>protocol)
   s <span style="color:#719e07">=</span> <span style="color:#b58900">open</span>(configFile, <span style="color:#2aa198">&#39;r+&#39;</span>)<span style="color:#719e07">.</span>read()
   s <span style="color:#719e07">=</span> s<span style="color:#719e07">.</span>replace(<span style="color:#2aa198">&#34;__PROTO__&#34;</span>, args<span style="color:#719e07">.</span>protocol)
   s <span style="color:#719e07">=</span> s<span style="color:#719e07">.</span>replace(<span style="color:#2aa198">&#34;__DOMAIN__&#34;</span>, args<span style="color:#719e07">.</span>domain)
   <span style="color:#b58900">file</span> <span style="color:#719e07">=</span> <span style="color:#b58900">open</span>(configFile, <span style="color:#2aa198">&#39;w&#39;</span>)
   <span style="color:#b58900">file</span><span style="color:#719e07">.</span>write(s)
   <span style="color:#b58900">file</span><span style="color:#719e07">.</span>close()
</code></pre></div><p>Really, really simple. It takes a domain and protocol arugment and will asjust my _Config.yml file accordingly. It should be noted I made a change to my config file to look like:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#719e07">title</span>: <span style="color:#2aa198">&#34;i-py&#34;</span>
<span style="color:#719e07">title2</span>: <span style="color:#2aa198">&#34;.com&#34;</span> 
<span style="color:#719e07">description</span>: <span style="color:#2aa198">&#34;The personal technical blog of Francis Setash. &#34;</span>
<span style="color:#719e07">url</span>: __PROTO__://__DOMAIN__ <span style="color:#586e75"># site url</span>
</code></pre></div><p><em>This means I can reuse the same transform script for multiple subdomains (or primary domains)</em></p>
<h3 id="finally-we-upload-to-s3">Finally, We Upload to S3</h3>
<p>This is using the <a href="https://wiki.jenkins-ci.org/display/JENKINS/S3+Plugin_">S3 Plugin</a> and really isnt much to discuss. It dumps the contents of ./_site into my Staging S3 bucket; which is viewable at <a href="http://staging.i-py.com">http://staging.i-py.com</a> (dont blame me if you visit and it is broken at some point!)</p>
<h3 id="some-final-notes">Some final notes:</h3>
<p>This workflow is duplicated into a second Jenkins job named &ldquo;publish blog&rdquo; and really the only differentiation is the branch it looks at, and the parameters it passes the transform script.</p>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/jekyll">jekyll</a></li>
								
								<li><a href="/tags/jenkins">jenkins</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright © - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
