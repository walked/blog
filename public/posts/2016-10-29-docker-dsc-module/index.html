<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>PowerShell DSC Module for Docker - Initial Stab - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="PowerShell DSC Module for Docker - Initial Stab" />
<meta property="og:description" content="So, first and foremost - this is a first take. I already have plans to add docker swarm provisioning, better system checks (e.g. verification that appropriate system patches are in place) and an option to select docker version (or latest) to install." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2016-10-29-docker-dsc-module/" />
<meta property="article:published_time" content="2016-10-29T12:32:30-05:00" />
<meta property="article:modified_time" content="2016-10-29T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="PowerShell DSC Module for Docker - Initial Stab"/>
<meta name="twitter:description" content="So, first and foremost - this is a first take. I already have plans to add docker swarm provisioning, better system checks (e.g. verification that appropriate system patches are in place) and an option to select docker version (or latest) to install."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">PowerShell DSC Module for Docker - Initial Stab</h1>
			<div class="meta">Posted on &mdash; Oct 29, 2016</div>
		</div>

		<div class="markdown">
			<p>So, first and foremost - this is a first take. I already have plans to add docker swarm provisioning, better system checks (e.g. verification that appropriate system patches are in place) and an option to select docker version (or latest) to install.</p>
<p>Nonetheless, I found it troubling that I couldnt find much in the way of installing Docker via DSC. So here we are. Notes: This is using Powershell Classes, so PS 5.0 is required; given that I dont think many people are deploying Docker in a scenario without 5.0, I&rsquo;m not too worried about it :) So first and foremost; this is now in the PowerShell Gallery. <a href="https://www.powershellgallery.com/packages/cDscDocker">https://www.powershellgallery.com/packages/cDscDocker</a> Update: also on GitHub: <a href="https://github.com/walked/cDscDocker">https://github.com/walked/cDscDocker</a> And you can quickly install the Module with the following:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">PS&gt;  Install-Module -Name cDscDocker
</code></pre></div><p>Cool. Let&rsquo;s see about use:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">Configuration dockerConfig
{
    Import-DscResource -module cDscDocker

    Node localhost{

		LocalConfigurationManager
		{
			RebootNodeIfNeeded = $true
		}

        cDscDocker ExampleA
        {
        docker = &#34;docker&#34;
        Ensure = &#39;Present&#39;

        }
    }
}

dockerConfig
</code></pre></div><p>And finally, run DSC on the host, be it via push or pull.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">#Only if you want to automatically reboot the node after docker install:
PS&gt; Set-DscLocalConfigurationManager .\dockerConfig\ 

PS&gt; Start-DscConfiguration .\dockerConfig\ -wait -force
</code></pre></div><p>Cool. What other featuures are planned for version 1.1:</p>
<ul>
<li>Improved comments.</li>
<li>Expanded pre-flight-checks to cover necessary Server 2016 pre-Docker patching</li>
<li>Expended configuration via DSC</li>
<li>Swarm joins</li>
<li>Docker daemon exposure on external interfaces</li>
<li>Perhaps overlay network configurations?</li>
<li>More? We&rsquo;ll see!</li>
</ul>
<p>  Full code for Version 1.0 <em>At an aside; it&rsquo;s really cool to see how Powershell 5.0 and PS Classes are incredibly powerful; doubly so if you have any experience with C#. Really phenomenal.</em></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">enum Ensure
{
	Present
	Absent
}

[DscResource()]
class cDscDocker 
{
	[DscProperty(Key)] 
	<span style="color:#cb4b16">[string]</span><span style="color:#268bd2">$docker</span>

	[DscProperty(<span style="color:#719e07">Mandatory</span>)] 
	<span style="color:#cb4b16">[Ensure]</span><span style="color:#268bd2">$Ensure</span>

	<span style="color:#586e75">#Equivalent of Set-TargetResource</span>
	<span style="color:#586e75">#Executes the current operation necessary to get the system to the desired state</span>
	<span style="color:#cb4b16">[void]</span> Set()
	{
		<span style="color:#719e07">if</span> (<span style="color:#268bd2">$this</span>.Ensure <span style="color:#719e07">-eq</span> <span style="color:#cb4b16">[Ensure]</span>::Present)
		{

			<span style="color:#719e07">if</span> (<span style="color:#719e07">-not</span> <span style="color:#268bd2">$this</span>.CheckDockerProvider()) <span style="color:#586e75">#If the docker provider isnt present</span>
			{
				<span style="color:#268bd2">$this</span>.InstallDockerProvider()

			}
			<span style="color:#268bd2">$this</span>.InstallDocker() <span style="color:#586e75">#Install docker..</span>

		}

		<span style="color:#719e07">elseif</span> (<span style="color:#268bd2">$this</span>.Ensure <span style="color:#719e07">-eq</span> <span style="color:#cb4b16">[Ensure]</span>::Absent)
		{
			<span style="color:#b58900">Uninstall-Package</span> -ProviderName DockerMsftProvider -Name docker -Force <span style="color:#586e75">#Uninstall docker; will move to a function if re-used elsewhere</span>
		}

	}

	<span style="color:#586e75">#Equivalent of Test-TargetResource</span>
	<span style="color:#586e75">#Returns true if system is in the state specified; false if a modification needs to take place</span>
	<span style="color:#cb4b16">[bool]</span> Test()
	{

		<span style="color:#268bd2">$dockerPresent</span> = <span style="color:#268bd2">$this</span>.CheckDocker()
		<span style="color:#268bd2">$returnValue</span> = <span style="color:#268bd2">$false</span>

		<span style="color:#719e07">if</span> (<span style="color:#268bd2">$this</span>.Ensure <span style="color:#719e07">-eq</span> <span style="color:#cb4b16">[Ensure]</span>::Present)
		{

			<span style="color:#719e07">if</span> (<span style="color:#268bd2">$dockerPresent</span>)
			{
				<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Item exists. Expected present&#34;</span>
				<span style="color:#268bd2">$returnValue</span> = <span style="color:#268bd2">$true</span>
			}
			<span style="color:#719e07">if</span> (<span style="color:#719e07">-not</span> <span style="color:#268bd2">$dockerPresent</span>)
			{
				<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Item is Absent. Expect Present&#34;</span>
				<span style="color:#268bd2">$returnValue</span> = <span style="color:#268bd2">$false</span>
			}
		}
		<span style="color:#719e07">Else</span>
		{
			<span style="color:#719e07">if</span> (<span style="color:#268bd2">$dockerPresent</span>)
			{
				<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Item exists. Expect Absent&#34;</span>
				<span style="color:#268bd2">$returnValue</span> = <span style="color:#268bd2">$false</span>
			}
			<span style="color:#719e07">if</span> (<span style="color:#719e07">-not</span> <span style="color:#268bd2">$dockerPresent</span>)
			{
				<span style="color:#b58900">Write-Verbose</span> <span style="color:#2aa198">&#34;Item absent. Expect Absent&#34;</span>
				<span style="color:#268bd2">$returnValue</span> = <span style="color:#268bd2">$true</span>
			}

		}

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$returnValue</span>

	}

	<span style="color:#586e75">#Equivalent of the Get-TargetResource</span>
	<span style="color:#586e75">#Get&#39;s the current state of the system in cDscDocker object form</span>
	<span style="color:#cb4b16">[cDscDocker]</span> Get()
	{
		<span style="color:#719e07">if</span> (<span style="color:#268bd2">$this</span>.CheckDocker())
		{
			<span style="color:#268bd2">$this</span>.Ensure = <span style="color:#cb4b16">[Ensure]</span>::Present
		}
		<span style="color:#719e07">else</span>
		{
			<span style="color:#268bd2">$this</span>.Ensure = <span style="color:#cb4b16">[Ensure]</span>::Absent
		}

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$this</span>

	}

	<span style="color:#586e75">#Function for installation of docker</span>
	<span style="color:#cb4b16">[void]</span>InstallDocker()
	{
		<span style="color:#b58900">Install-Package</span> -Name docker -ProviderName DockerMsftProvider -Force
		<span style="color:#268bd2">$global:DSCMachineStatus</span> = 1
	}

	<span style="color:#586e75">#Function for installation of docker package provider</span>
	<span style="color:#cb4b16">[void]</span>InstallDockerProvider()
	{
		<span style="color:#b58900">Install-Module</span> -Name DockerMsftProvider -Repository psgallery -Force
	}

	<span style="color:#586e75">#Function to check if docker is already present</span>
	<span style="color:#cb4b16">[bool]</span>CheckDocker()
	{
        <span style="color:#268bd2">$installed</span> = <span style="color:#268bd2">$false</span>

        <span style="color:#719e07">if</span>(<span style="color:#268bd2">$this</span>.CheckDockerProvider())
        {

		    <span style="color:#268bd2">$packages</span> = <span style="color:#b58900">Get-Package</span> -ProviderName DockerMsftProvider
		    <span style="color:#719e07">foreach</span> (<span style="color:#268bd2">$p</span> <span style="color:#719e07">in</span> <span style="color:#268bd2">$packages</span>)
		    {
			    <span style="color:#719e07">if</span> (<span style="color:#268bd2">$p</span>.Name <span style="color:#719e07">-eq</span> <span style="color:#2aa198">&#39;docker&#39;</span>)
			    {
				    <span style="color:#268bd2">$installed</span> = <span style="color:#268bd2">$true</span>
			    }
		    }
        }

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$installed</span>
	}

	<span style="color:#586e75">#Function to verify the appropriate docker package provider is available on the host</span>
	<span style="color:#cb4b16">[bool]</span>CheckDockerProvider()
	{
		<span style="color:#268bd2">$available</span> = <span style="color:#268bd2">$false</span>
		<span style="color:#268bd2">$providers</span> = <span style="color:#b58900">Get-PackageProvider</span> -ListAvailable

		<span style="color:#719e07">foreach</span>(<span style="color:#268bd2">$provider</span> <span style="color:#719e07">in</span> <span style="color:#268bd2">$providers</span>)
        {
		    <span style="color:#719e07">if</span> (<span style="color:#268bd2">$provider</span>.Name <span style="color:#719e07">-eq</span> <span style="color:#2aa198">&#34;DockerMsftProvider&#34;</span>)
		    {
			    <span style="color:#268bd2">$available</span> = <span style="color:#268bd2">$true</span>
		    }
        }

		<span style="color:#719e07">return</span> <span style="color:#268bd2">$available</span>
	}
}


</code></pre></div><p><em>Update: The version in the PS Gallery is now up to 1.0.5; please note this has some important fixes to the DSC Provider check, as well as implements automatic system reboots if your LCM settings support it.</em></p>
<p>_Update2: Code here is updated to reflect the important fixes. _</p>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/docker">docker</a></li>
								
								<li><a href="/tags/windows">windows</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright © - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
