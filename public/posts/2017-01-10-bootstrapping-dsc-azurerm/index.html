<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>AzureRM - Bootstrapping DSC LCM - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="AzureRM - Bootstrapping DSC LCM" />
<meta property="og:description" content="So, a brief tidbit if you&rsquo;re not using Azure automation for your Azure VMs (we have a subset that are managed with a pull server that are not Azure automation controlled. So, at provisioning time we wanted to look at provisioning the VM with the LCM meta configuration, to avoid additional work by hand. It&rsquo;s pretty simple, but required a different approach between WMF 4.0 and WMF 5.0 (read: Server 2012 and Server 2016). Let&rsquo;s discuss:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2017-01-10-bootstrapping-dsc-azurerm/" />
<meta property="article:published_time" content="2017-01-10T12:32:30-05:00" />
<meta property="article:modified_time" content="2017-01-10T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AzureRM - Bootstrapping DSC LCM"/>
<meta name="twitter:description" content="So, a brief tidbit if you&rsquo;re not using Azure automation for your Azure VMs (we have a subset that are managed with a pull server that are not Azure automation controlled. So, at provisioning time we wanted to look at provisioning the VM with the LCM meta configuration, to avoid additional work by hand. It&rsquo;s pretty simple, but required a different approach between WMF 4.0 and WMF 5.0 (read: Server 2012 and Server 2016). Let&rsquo;s discuss:"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">AzureRM - Bootstrapping DSC LCM</h1>
			<div class="meta">Posted on &mdash; Jan 10, 2017</div>
		</div>

		<div class="markdown">
			<p>So, a brief tidbit if you&rsquo;re not using Azure automation for your Azure VMs (we have a subset that are managed with a pull server that are not Azure automation controlled. So, at provisioning time we wanted to look at provisioning the VM with the LCM meta configuration, to avoid additional work by hand. It&rsquo;s pretty simple, but required a different approach between WMF 4.0 and WMF 5.0 (read: Server 2012 and Server 2016). Let&rsquo;s discuss:</p>
<h3 id="server-2016--"><strong>Server 2016</strong> -</h3>
<p>As it turns out the PowerShell DSC Extension doesnt  support <code>[DSCLocalConfigurationManager()]</code> . Darn. So, the next best thing is a hyper-simple script running in the Custom Script Extension:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">[DSCLocalConfigurationManager()]
configuration PullClientConfigID
{
    Node localhost
    {
        Settings
        {
            RebootNodeIfNeeded   = <span style="color:#268bd2">$true</span>

        }

    }
}

PullClientConfigID -OutputPath C:\Config

<span style="color:#b58900">Set-DscLocalConfigurationManager</span> -Path C:\Config
</code></pre></div><p><em>Note: this LCM config left intentionally simple!</em> And then we just set up the Azure RM template with a Custom Script Extension:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
              <span style="color:#268bd2">&#34;name&#34;</span>: <span style="color:#2aa198">&#34;configLcm&#34;</span>,
              <span style="color:#268bd2">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;extensions&#34;</span>,
              <span style="color:#268bd2">&#34;location&#34;</span>: <span style="color:#2aa198">&#34;[resourceGroup().location]&#34;</span>,
              <span style="color:#268bd2">&#34;apiVersion&#34;</span>: <span style="color:#2aa198">&#34;2015-06-15&#34;</span>,
              <span style="color:#268bd2">&#34;dependsOn&#34;</span>: [
                  <span style="color:#2aa198">&#34;[resourceId(&#39;Microsoft.Compute/virtualMachines&#39;, variables(&#39;vmName&#39;))]&#34;</span>
              ],
              <span style="color:#268bd2">&#34;tags&#34;</span>: {
                  <span style="color:#268bd2">&#34;displayName&#34;</span>: <span style="color:#2aa198">&#34;configLcm&#34;</span>
              },
              <span style="color:#268bd2">&#34;properties&#34;</span>: {
                  <span style="color:#268bd2">&#34;publisher&#34;</span>: <span style="color:#2aa198">&#34;Microsoft.Compute&#34;</span>,
                  <span style="color:#268bd2">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;CustomScriptExtension&#34;</span>,
                  <span style="color:#268bd2">&#34;typeHandlerVersion&#34;</span>: <span style="color:#2aa198">&#34;1.4&#34;</span>,
                  <span style="color:#268bd2">&#34;autoUpgradeMinorVersion&#34;</span>: <span style="color:#cb4b16">true</span>,
                  <span style="color:#268bd2">&#34;settings&#34;</span>: {
                      <span style="color:#268bd2">&#34;fileUris&#34;</span>: [
                          <span style="color:#2aa198">&#34;[concat(parameters(&#39;_artifactsLocation&#39;), &#39;/&#39;, variables(&#39;configLcmScriptFolder&#39;), &#39;/&#39;, variables(&#39;configLcmScriptFileName&#39;), parameters(&#39;_artifactsLocationSasToken&#39;))]&#34;</span>
                      ],
                      <span style="color:#268bd2">&#34;commandToExecute&#34;</span>: <span style="color:#2aa198">&#34;[concat(&#39;powershell -ExecutionPolicy Unrestricted -File &#39;, variables(&#39;configLcmScriptFolder&#39;), &#39;/&#39;, variables(&#39;configLcmScriptFileName&#39;))]&#34;</span>
                  }
              }
          }
</code></pre></div><p>And we&rsquo;re off to the races upon provisioning.</p>
<h3 id="server-2012-r2">Server 2012 R2</h3>
<p>This is a situation where we can simply use the DSC extension in the Azure RM template. Simpler.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Configuration Main
{

<span style="color:#719e07">Param</span> ( <span style="color:#cb4b16">[string]</span> <span style="color:#268bd2">$nodeName</span> )

<span style="color:#b58900">Import-DscResource</span> -ModuleName PSDesiredStateConfiguration

Node <span style="color:#268bd2">$nodeName</span>
  {
   LocalConfigurationManager
        {
            RebootNodeIfNeeded = <span style="color:#268bd2">$true</span>
        }
  }
}
</code></pre></div><p>And then, the supporting template configuration:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
              <span style="color:#268bd2">&#34;name&#34;</span>: <span style="color:#2aa198">&#34;Microsoft.Powershell.DSC&#34;</span>,
              <span style="color:#268bd2">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;extensions&#34;</span>,
              <span style="color:#268bd2">&#34;location&#34;</span>: <span style="color:#2aa198">&#34;[resourceGroup().location]&#34;</span>,
              <span style="color:#268bd2">&#34;apiVersion&#34;</span>: <span style="color:#2aa198">&#34;2015-06-15&#34;</span>,
              <span style="color:#268bd2">&#34;dependsOn&#34;</span>: [
                  <span style="color:#2aa198">&#34;[resourceId(&#39;Microsoft.Compute/virtualMachines&#39;, variables(&#39;vmName&#39;))]&#34;</span>
              ],
              <span style="color:#268bd2">&#34;tags&#34;</span>: {
                  <span style="color:#268bd2">&#34;displayName&#34;</span>: <span style="color:#2aa198">&#34;configLcm&#34;</span>
              },
              <span style="color:#268bd2">&#34;properties&#34;</span>: {
                  <span style="color:#268bd2">&#34;publisher&#34;</span>: <span style="color:#2aa198">&#34;Microsoft.Powershell&#34;</span>,
                  <span style="color:#268bd2">&#34;type&#34;</span>: <span style="color:#2aa198">&#34;DSC&#34;</span>,
                  <span style="color:#268bd2">&#34;typeHandlerVersion&#34;</span>: <span style="color:#2aa198">&#34;2.9&#34;</span>,
                  <span style="color:#268bd2">&#34;autoUpgradeMinorVersion&#34;</span>: <span style="color:#cb4b16">true</span>,
                  <span style="color:#268bd2">&#34;forceUpdateTag&#34;</span>: <span style="color:#2aa198">&#34;[parameters(&#39;configLcmUpdateTagVersion&#39;)]&#34;</span>,
                  <span style="color:#268bd2">&#34;settings&#34;</span>: {
                      <span style="color:#268bd2">&#34;configuration&#34;</span>: {
                          <span style="color:#268bd2">&#34;url&#34;</span>: <span style="color:#2aa198">&#34;[concat(parameters(&#39;_artifactsLocation&#39;), &#39;/&#39;, variables(&#39;configLcmArchiveFolder&#39;), &#39;/&#39;, variables(&#39;configLcmArchiveFileName&#39;))]&#34;</span>,
                          <span style="color:#268bd2">&#34;script&#34;</span>: <span style="color:#2aa198">&#34;configLcm.ps1&#34;</span>,
                          <span style="color:#268bd2">&#34;function&#34;</span>: <span style="color:#2aa198">&#34;Main&#34;</span>
                      },
                      <span style="color:#268bd2">&#34;configurationArguments&#34;</span>: {
                          <span style="color:#268bd2">&#34;nodeName&#34;</span>: <span style="color:#2aa198">&#34;[variables(&#39;vmName&#39;)]&#34;</span>
                      }
                  },
                  <span style="color:#268bd2">&#34;protectedSettings&#34;</span>: {
                      <span style="color:#268bd2">&#34;configurationUrlSasToken&#34;</span>: <span style="color:#2aa198">&#34;[parameters(&#39;_artifactsLocationSasToken&#39;)]&#34;</span>
                  }
              }
          }
</code></pre></div><p>  Pretty straightforward. In a more realistic example (and what we&rsquo;re doing) you&rsquo;d also configure your pull / report server and any other LCM metadata you want to setup.</p>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/windows">windows</a></li>
								
								<li><a href="/tags/powershell">powershell</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright © - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
