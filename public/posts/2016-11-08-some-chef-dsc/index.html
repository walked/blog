<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Some Chef, Some DSC - Website Deployment - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Some Chef, Some DSC - Website Deployment" />
<meta property="og:description" content="If you know me, you know I like what DSC does. What recently came to my attention is that Chef can leverage DSC and that&rsquo;s pretty cool." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2016-11-08-some-chef-dsc/" />
<meta property="article:published_time" content="2016-11-02T12:32:30-05:00" />
<meta property="article:modified_time" content="2016-11-02T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Some Chef, Some DSC - Website Deployment"/>
<meta name="twitter:description" content="If you know me, you know I like what DSC does. What recently came to my attention is that Chef can leverage DSC and that&rsquo;s pretty cool."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Some Chef, Some DSC - Website Deployment</h1>
			<div class="meta">Posted on &mdash; Nov 2, 2016</div>
		</div>

		<div class="markdown">
			<p>If you know me, you know I like what DSC does. What recently came to my attention is that Chef can leverage DSC and that&rsquo;s pretty cool.</p>
<p><em>First and foremost; the disclaimer: I&rsquo;m not particularly well versed in Chef; there&rsquo;s probably better ways to do this. I know there&rsquo;s an IIS cookbook in the Chef supermarket; but for testing I had a few troubles with this running the chef client in local mode.</em></p>
<p>Now; let&rsquo;s look at some DSC inside of Chef.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">dsc_script <span style="color:#2aa198">&#39;Web-Server&#39;</span> <span style="color:#719e07">do</span>
    code <span style="color:#2aa198">&lt;&lt;-EOH
</span><span style="color:#2aa198"></span>    <span style="color:#cb4b16">WindowsFeature</span> <span style="color:#cb4b16">InstallWebServer</span>
    {
        <span style="color:#cb4b16">Name</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Web-Server&#34;</span>
        <span style="color:#cb4b16">Ensure</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Present&#34;</span>
    }

    <span style="color:#cb4b16">EOH</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>Really pretty simple; it allows us to use the idempotent nature of native DSC without having to build our checks into the actual usage like this example from the Chef tutorial:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">powershell_script <span style="color:#2aa198">&#39;Install IIS&#39;</span> <span style="color:#719e07">do</span>
  code <span style="color:#2aa198">&#39;Add-WindowsFeature Web-Server&#39;</span>
  guard_interpreter <span style="color:#2aa198">:powershell_script</span>
  not_if <span style="color:#2aa198">&#34;(Get-WindowsFeature -Name Web-Server).Installed&#34;</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>Why does it matter? It may or may not matter that much depending on the resources you&rsquo;re using, but to me being able to leverage DSC inside of Chef, without building out a full DSC architecture seems so elegant to me. Chef handles the MOF compilation and the LCM configuration to actually execute the DSC configuration. Let&rsquo;s look at a full Chef script that&rsquo;ll put together a baseline web server, hit a remote repository for a zip file, and extract it into the IIS directory - only when changed.   First off, there&rsquo;s a pair of actions to draw attention to:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">remote_file <span style="color:#2aa198">&#34;Code Source&#34;</span> <span style="color:#719e07">do</span>
    source <span style="color:#2aa198">&#34;file:////synology.home.lan//storage//deploy//TestApplication.zip&#34;</span>
    path <span style="color:#2aa198">&#34;C:/temp/TestApplication.zip&#34;</span>
    notifies <span style="color:#2aa198">:run</span>, <span style="color:#2aa198">&#39;powershell_script[Extract Archive]&#39;</span>, <span style="color:#2aa198">:immediately</span>
<span style="color:#719e07">end</span>

powershell_script <span style="color:#2aa198">&#39;Extract Archive&#39;</span> <span style="color:#719e07">do</span>
    code <span style="color:#2aa198">&#39;Expand-Archive c:/temp/TestApplication.zip -DestinationPath c:/inetpub/wwwroot -force&#39;</span>
    guard_interpreter <span style="color:#2aa198">:powershell_script</span>
    action <span style="color:#2aa198">:nothing</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>What you should bring your attention to is namely the way that the powershell_script &lsquo;Extract Archive&rsquo;  has an action of:nothing &ldquo;which means unless otherwise called; when Chef&rsquo;s processing hits this action; it will do nothing. And then look at the remote_file &ldquo;Code Source&rdquo; action. What&rsquo;s worth of note is the notifies attribute. This effectively means &ldquo;do this when we become aware of a state change rectified by this particular action&rdquo;. So; in essence; we&rsquo;re only going to extract the archive in the event it&rsquo;s changed or was not present, and after it&rsquo;s copied over. All in all; full code to bring up an ASP.NET/IIS webserver, and copy the requisite code over, and update it if/when changed is below.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">dsc_script <span style="color:#2aa198">&#39;Web-Server&#39;</span> <span style="color:#719e07">do</span>
    code <span style="color:#2aa198">&lt;&lt;-EOH
</span><span style="color:#2aa198"></span>    <span style="color:#cb4b16">WindowsFeature</span> <span style="color:#cb4b16">InstallWebServer</span>
    {
        <span style="color:#cb4b16">Name</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Web-Server&#34;</span>
        <span style="color:#cb4b16">Ensure</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Present&#34;</span>
    }

    <span style="color:#cb4b16">EOH</span>
<span style="color:#719e07">end</span>

dsc_script <span style="color:#2aa198">&#39;ASP.NET&#39;</span> <span style="color:#719e07">do</span>
    code <span style="color:#2aa198">&lt;&lt;-EOH
</span><span style="color:#2aa198"></span>    <span style="color:#cb4b16">WindowsFeature</span> <span style="color:#cb4b16">InstallDotNet45</span>
    {
        <span style="color:#cb4b16">Name</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Web-Asp-Net45&#34;</span>
        <span style="color:#cb4b16">Ensure</span> <span style="color:#719e07">=</span> <span style="color:#2aa198">&#34;Present&#34;</span>
    }

    <span style="color:#cb4b16">EOH</span>
<span style="color:#719e07">end</span>

directory <span style="color:#2aa198">&#39;c:\temp&#39;</span> <span style="color:#719e07">do</span>
    action <span style="color:#2aa198">:create</span>
<span style="color:#719e07">end</span>

remote_file <span style="color:#2aa198">&#34;Code Source&#34;</span> <span style="color:#719e07">do</span>
    source <span style="color:#2aa198">&#34;file:////synology.home.lan//storage//deploy//TestApplication.zip&#34;</span>
    path <span style="color:#2aa198">&#34;C:/temp/TestApplication.zip&#34;</span>
    notifies <span style="color:#2aa198">:run</span>, <span style="color:#2aa198">&#39;powershell_script[Extract Archive]&#39;</span>, <span style="color:#2aa198">:immediately</span>
<span style="color:#719e07">end</span>

service <span style="color:#2aa198">&#39;w3svc&#39;</span> <span style="color:#719e07">do</span>
  action <span style="color:#719e07">[</span><span style="color:#2aa198">:enable</span>, <span style="color:#2aa198">:start</span><span style="color:#719e07">]</span>
<span style="color:#719e07">end</span>

powershell_script <span style="color:#2aa198">&#39;Extract Archive&#39;</span> <span style="color:#719e07">do</span>
    code <span style="color:#2aa198">&#39;Expand-Archive c:/temp/TestApplication.zip -DestinationPath c:/inetpub/wwwroot -force&#39;</span>
    guard_interpreter <span style="color:#2aa198">:powershell_script</span>
    action <span style="color:#2aa198">:nothing</span>
<span style="color:#719e07">end</span>
</code></pre></div><p>Super simple; definitely not something prepared to scale - but it <em>does</em> give you an idea of the integration between DSC and Chef.</p>
<p><em>I&rsquo;d like to note that in local-mode Chef-client, the chef-client consistently reports that DSC cannot parse the LCM output. This could be because I&rsquo;m running on Server 2016 / PowerShell v5; or it could be a quirk in local mode. Regardless, at this time Chef will report a change for every single DSC action, regardless of a change happening.</em></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">Running handlers:
Running handlers complete
Chef Client finished, 2/9 resources updated in 25 seconds
</code></pre></div><p><strong>Next Up:</strong> Ensuring WebDeploy is installed on a host; and using <em>that</em> for application deployment rather than just extracting an archive.</p>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/chef">chef</a></li>
								
								<li><a href="/tags/windows">windows</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright © - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
