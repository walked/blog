<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Terraform - Psuedu Nested For-Loop and Usergen Release - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Terraform - Psuedu Nested For-Loop and Usergen Release" />
<meta property="og:description" content="So. I am using Terraform to generate a bunch of users and wanted to modularize it as much as possible. I wanted to get to a point where I could provide a set of aws_iam_user objects and aws_iam_user_policy_attachments and have the module cleanly handle this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2017-11-02-terraform-usergen/" />
<meta property="article:published_time" content="2017-11-02T12:32:30-05:00" />
<meta property="article:modified_time" content="2017-11-02T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Terraform - Psuedu Nested For-Loop and Usergen Release"/>
<meta name="twitter:description" content="So. I am using Terraform to generate a bunch of users and wanted to modularize it as much as possible. I wanted to get to a point where I could provide a set of aws_iam_user objects and aws_iam_user_policy_attachments and have the module cleanly handle this."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Terraform - Psuedu Nested For-Loop and Usergen Release</h1>
			<div class="meta">Posted on &mdash; Nov 2, 2017</div>
		</div>

		<div class="markdown">
			<p>So. I am using Terraform to generate a bunch of users and wanted to modularize it as much as possible. I wanted to get to a point where I could provide a set of <code>aws_iam_user</code> objects and <code>aws_iam_user_policy_attachments</code> and have the module cleanly handle this.</p>
<p>Normally, you&rsquo;d do something like:</p>
<p><em>PsuedoCode:</em></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">for user in user_names {
    createUser(user.Name)
    for policy in iam_policies {
        attachPolicy(user.Name, policy.id)
    }
}
</code></pre></div><p>But we dont have for loops; just the <code>count</code> property.</p>
<p>So we have to get funky and figure out how to iterate over ALL possible combinations of two terraform lists for this to work.</p>
<p>Lets start with how we declare the users:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">module &#34;users&#34; {
    source = source = &#34;walked/usergen/aws&#34;
    pgp_key = &#34;keybase:walked&#34;
    user_names = [&#34;Test1&#34;,&#34;test2&#34;]
    iam_policies = [&#34;arn:aws:iam::aws:policy/IAMUserChangePassword&#34;, &#34;${aws_iam_policy.example_policy.arn}&#34;]    
}
</code></pre></div><p>Simple enough; I want two users (Test1, Test2) and both user to have two different IAM policies attached. This means that I technically need to create 4 policy attachments; one for each policy for each user.</p>
<p>So; how do we tackle this? Let&rsquo;s walk through it.</p>
<p>First; we have to iterate over all combinations (multiple number of users by number of policies):</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">resource &#34;aws_iam_user_policy_attachment&#34; &#34;policy_attach&#34; {
	count         = &#34;${length(var.iam_policies) * length(var.user_names)}&#34;
</code></pre></div><p>Next; we need to make sure we end up with usable user indexes. This will take the count (in our example; we&rsquo;re going to have a count of 4; so <code>count.index</code> values of <code>0, 1, 2, 3</code> and we need to be sure that we&rsquo;re going to get the index results of <code>0, 0, 1, 1</code>):</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">    user          = &#34;${var.user_names[count.index % length(var.user_names)]}&#34;
</code></pre></div><p>Finally; we need to get the possible policies for each user and index. We take advantage of integer truncation to get the desired result here:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">	policy_arn    = &#34;${var.iam_policies[(count.index) / length(var.user_names)]}&#34;
</code></pre></div><p>This gets us a values of <code>0, 1, 0, 1</code> as we iterate. It&rsquo;ll scale with the number of users/policies.</p>
<p>Full snippet and links:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">resource &#34;aws_iam_user_policy_attachment&#34; &#34;policy_attach&#34; {
    count         = &#34;${length(var.iam_policies) * length(var.user_names)}&#34;
    user          = &#34;${var.user_names[count.index % length(var.user_names)]}&#34;
    policy_arn    = &#34;${var.iam_policies[(count.index) / length(var.user_names)]}&#34;
    depends_on    = [&#34;aws_iam_user.this&#34;]
}
</code></pre></div><p><strong>GitHub:</strong> <a href="https://github.com/walked/terraform-aws-usergen">https://github.com/walked/terraform-aws-usergen</a></p>
<p><strong>Terraform Registry:</strong> <a href="https://registry.terraform.io/modules/walked/usergen/aws/1.0.3">https://registry.terraform.io/modules/walked/usergen/aws/1.0.3</a></p>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/windows">windows</a></li>
								
								<li><a href="/tags/terraform">terraform</a></li>
								
								<li><a href="/tags/aws">aws</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright Â© - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
