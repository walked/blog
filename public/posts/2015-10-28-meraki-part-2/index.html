<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Meraki VPN Deployment Part 2 - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Meraki VPN Deployment Part 2" />
<meta property="og:description" content="Well, humble pie time. But this is good stuff here. Turns out I missed one little teeny tiny flag in the Add-VpnConnection cmdlet. Oops. But this is good!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2015-10-28-meraki-part-2/" />
<meta property="article:published_time" content="2015-10-28T12:32:30-05:00" />
<meta property="article:modified_time" content="2015-10-28T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Meraki VPN Deployment Part 2"/>
<meta name="twitter:description" content="Well, humble pie time. But this is good stuff here. Turns out I missed one little teeny tiny flag in the Add-VpnConnection cmdlet. Oops. But this is good!"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Meraki VPN Deployment Part 2</h1>
			<div class="meta">Posted on &mdash; Oct 28, 2015</div>
		</div>

		<div class="markdown">
			<p>Well, humble pie time. But this is good stuff here. Turns out I missed one little teeny tiny flag in the Add-VpnConnection cmdlet. Oops. But this is good!</p>
<p>With PowerShell 4.0 you can deploy a fully functional Meraki VPN Client profile. <em>AND</em> you can setup split tunneling. Granted; you cant push all the VPN subnets from the Meraki side; but this works and works pretty well. _Meraki guys - _<em>take note because this is way better than your documentation.</em> So, first and foremost, let&rsquo;s see about JUST adding a VPN Profile that&rsquo;s compatible with Meraki gear in a single line:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#b58900">Add-VpnConnection</span> -L2tpPsk <span style="color:#2aa198">&#39;KEY&#39;</span> -name <span style="color:#2aa198">&#39;ConnectionName&#39;</span> -ServerAddress <span style="color:#2aa198">&#39;Endpoint IP or Host&#39;</span> -AllUserConnection -AuthenticationMethod Pap -TunnelType L2tp -Force
</code></pre></div><p>Cool. Easy. It was the <strong>L2tpPsk</strong> parameter that I&rsquo;d missed. Darn it. Now lets talk about split tunneling. So, per the <a href="https://documentation.meraki.com/MX-Z/Client_VPN/Configuring_Split-tunnel_Client_VPN">Meraki documentation:</a></p>
<p>Let&rsquo;s see here:</p>
<ul>
<li>Can only be set when the VPN connection is up and running (ugh, this just about kills my deployment dreams)</li>
<li>Requires the ifIndex; which is only possible to pull when the VPN tunnel is up (Get-NetIPAdapter wont pull virtual disconnected adapters. Sigh)</li>
<li>ugh</li>
</ul>
<p>Well, lets see here.. what else can we get done in PowerShell 4.0+?</p>
<p>Enter: **Add-VpnConnectionRoute **
<a href="https://technet.microsoft.com/en-us/%5Clibrary/dn262649(v=wps.630).aspx">https://technet.microsoft.com/en-us/%5Clibrary/dn262649(v=wps.630).aspx</a></p>
<p>Hm; well that&rsquo;s something. But how does this compare to the route commands in the Meraki documentation? I wonder&hellip;</p>
<p><img src="%7B%7Bsite.url%7D%7D/assets/images/meraki/route.png" alt="route"> 
What? So using the Add-VpnConnectionRoute does <em>not</em> add the route to the route table.</p>
<p>That&rsquo;s strange. I wonder what happens when I connect to the VPN connection.. 
<img src="%7B%7Bsite.url%7D%7D/assets/images/meraki/routes.png" alt="routes"> 
YES! But&hellip; it&rsquo;s not listed as a persistent route. Does it survive a reboot? (Hint: Yes it does). So thats a whole lot of writing for basically two lines of PowerShell. I&rsquo;m putting together a more-full script that&rsquo;ll parse an XML file full of subnets and VPN paramters, which will be posted here once it&rsquo;s firmed up! Until then, to deploy Meraki with split-tunneling via PowerShell 4.0+</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#b58900">Add-VpnConnection</span> -L2tpPsk <span style="color:#2aa198">&#39;KEY&#39;</span> -name <span style="color:#2aa198">&#39;ConnectionName&#39;</span> -ServerAddress <span style="color:#2aa198">&#39;Endpoint IP or Host&#39;</span> -AllUserConnection -AuthenticationMethod Pap -TunnelType L2tp -SplitTunneling -Force
<span style="color:#b58900">Add-VpnConnectionRoute</span> -AllUserConnection -ConnectionName <span style="color:#2aa198">&#39;ConnectionName&#39;</span> -DestinationPrefix 10.1.1.0/24&lt;/pre&gt;
</code></pre></div>
		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/networking">networking</a></li>
								
								<li><a href="/tags/vpn">vpn</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright © - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
