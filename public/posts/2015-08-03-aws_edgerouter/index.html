<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Connecting Ubiquiti EdgeRouter to AWS VPC - i-py.com</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Connecting Ubiquiti EdgeRouter to AWS VPC" />
<meta property="og:description" content="I&rsquo;m of the mind that many small businesses can benefit greatly from extending their IT systems into the cloud. AWS is price effective (especially on a 1 year reserved term), and offers built-in VPN connectivity options via their VPC." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://i-py.com/posts/2015-08-03-aws_edgerouter/" />
<meta property="article:published_time" content="2015-08-03T12:32:30-05:00" />
<meta property="article:modified_time" content="2015-08-03T12:32:30-05:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Connecting Ubiquiti EdgeRouter to AWS VPC"/>
<meta name="twitter:description" content="I&rsquo;m of the mind that many small businesses can benefit greatly from extending their IT systems into the cloud. AWS is price effective (especially on a 1 year reserved term), and offers built-in VPN connectivity options via their VPC."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://i-py.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://i-py.com/css/custom.css" />
	

	
	<script src="https://i-py.com/js/main.js"></script>
	<script src="https://i-py.com/js/abc.js"></script>
	<script src="https://i-py.com/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="https://i-py.com/">
	<h1 class="site-title"><a href="https://i-py.com/">i-py.com</a></h1>
	<div class="site-description"><h2>Technical Blog of Francis Setash</h2><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Connecting Ubiquiti EdgeRouter to AWS VPC</h1>
			<div class="meta">Posted on &mdash; Aug 3, 2015</div>
		</div>

		<div class="markdown">
			<p>I&rsquo;m of the mind that many small businesses can benefit greatly from extending their IT systems into the cloud. AWS is price effective (especially on a 1 year reserved term), and offers built-in VPN connectivity options via their VPC. It&rsquo;s really a quite powerful environment to work with.</p>
<p>For example, you could run a t2.small Windows Server 2012 instance for around $25 a month + VPN costs of around $35/month. $60 for a fully hosted domain controller including Windows Server licensing costs and Amazon&rsquo;s EC2 ability-to-scale/redundancy is pretty good.</p>
<p>Unfortunately for the small business/organization, many of the routers that will properly support the IPSec Site-to-Site tunnel can be burdensome in price. Enter the EdgeRouter Lite. 3 ports, based on VyOS 6.3, and $100 for 3xGigE ports. Really solid package. The downside? Documentation is a bit lacking. Ubiquiti sources a lot of documentation to the user community, and what they do publish can often not quite line up with your scenario. VyOS documentation is out there, but not always consistent.</p>
<p>So let&rsquo;s walk through an EdgeRouter to Amazon AWS VPC Configuration.</p>
<p><strong>Amazon Side:</strong> <em>(I&rsquo;m going to keep this simple and fast as the documentation on the Amazon side is pretty good)</em></p>
<ol>
<li>Ensure you have a VPC created and assigned a CIDR subnet. Mine is 172.31.0.0/16</li>
<li>Create a Customer Gateway. This is a simple one-page configuration. Name it what you want, set the routing to static, and for the IP address use the <em>external IP for your router</em>.</li>
<li>Create a Virtual Private Gateway. This is literally just creating a virtual router and takes no configuration.</li>
<li>Create a VPN connection. Name it what you want, set the Virtual Private Gateway to the gateway created in step 3, use the existing customer gateway from step 2, and select &ldquo;static&rdquo; for the routing option. For IP prefixes, specify your own local subnet (e.g. 192.168.1.0/24)</li>
<li>Right click on the created VPN connection and select &ldquo;Download Configuration&rdquo;. Select the &ldquo;Generic&rdquo; vendor and download the text file. You have everything you need to connect.</li>
</ol>
<p><strong>Ubiquiti Side:</strong> <em>(This is all via command line, sorry!)</em></p>
<ol>
<li>SSH to your router, PuTTY is going to be much easier to work with than the WebCLI due to copy/paste.</li>
<li>First, we need to create a Virtual Tunnel</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">configure
set interfaces vti vti0 address &lt;AWS_PEER_IP-PROBABLY 169.X.X.X&gt; 
## This IP address is listed in the Amazon Config as &#34;Inside IP Addresses&#34; - use the &#34;customer gateway&#34; here
set interfaces vti vti0 mtu 1436
</code></pre></div><ol start="3">
<li>Next, as a vti is a routable interface, we&rsquo;ll setup static routing for AWS</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">set protocols static interface-route &lt;AWS_VPC SUBNET/MASK&gt; next-hop-interface vti0 
#NOTE: This subnet is your VPC internal subnet. Mine is 172.31.0.0/16
</code></pre></div><ol start="4">
<li>Let&rsquo;s create the IPSec IKE Group and ESP Groups:</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">set vpn ipsec ike-group ikeGroup1
set vpn ipsec ike-group ikeGroup1 lifetime 28800
set vpn ipsec ike-group ikeGroup1 proposal 1 encryption aes128
set vpn ipsec ike-group ikeGroup1 proposal 1 hash sha1 
set vpn ipsec ike-group ikeGroup1 proposal 1 dh-group 2 
</code></pre></div><p><strong>Dead-Peer-Detection is SUPER important with AWS.</strong>
<strong>They will drop your connection like a hot potato if this isnt enabled and no traffic is passing.</strong></p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">set vpn ipsec ike-group ikeGroup1 dead-peer-detection action &#39;restart&#39;
set vpn ipsec ike-group ikeGroup1 dead-peer-detection interval &#39;10&#39;
set vpn ipsec ike-group ikeGroup1 dead-peer-detection timeout &#39;30&#39;    
set vpn ipsec esp-group espGroup1
set vpn ipsec esp-group espGroup1 compression disable
set vpn ipsec esp-group espGroup1 mode tunnel
set vpn ipsec esp-group espGroup1 pfs enable
set vpn ipsec esp-group espGroup1 lifetime 3600
set vpn ipsec esp-group espGroup1 proposal 1 encryption aes128
set vpn ipsec esp-group espGroup1 proposal 1 hash sha1
</code></pre></div><ol start="5">
<li>Now, we need to setup the IPSec Peer:</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; authentication id &lt;YOUR_EXTERNAL IP&gt;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; authentication mode pre-shared-secret
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; authentication pre-shared-secret &lt;PRE_SHARED_SECRET&gt;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; connection-type initiate
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; default-esp-group espGroup1
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; description &#34;tunnel1&#34;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; ike-group ikeGroup1
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; local-address &lt;YOUR_EXTERNAL_IP&gt;
</code></pre></div><p>Note: The AWS Peer IP will be listed in the Amazon config file as &ldquo;Virtual Private Gateway&rdquo;</p>
<ol start="6">
<li>Final steps. We need to bind the peer to the vti and esp-group and finally mark our external interface as the ipsec-interface</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; vti bind vti0
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; vti esp-group espGroup1
set vpn ipsec ipsec-interfaces interface &#39;eth1&#39; #Assuming your external interface is Eth1   
</code></pre></div><ol start="7">
<li>Verify connectivity!</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">user@router:~$ show vpn ipsec sa
Peer ID / IP                            Local ID / IP
------------                            -------------
X.X.X.X                                 Y.Y.Y.Y    
Description: tunne
Tunnel  State  Bytes Out/In   Encrypt  Hash  NAT-T  A-Time  L-Time  Proto
------  -----  -------------  -------  ----  -----  ------  ------  -----
vti     up     0.0/0.0        aes128   sha1  no     2967    3600    all
</code></pre></div><p><strong>Full Configuration Command List:</strong></p>
<pre><code>configure
set interfaces vti vti0 address &lt;AWS_PEER_IP-PROBABLY 169.X.X.X&gt;
set interfaces vti vti0 mtu 1436
set protocols static interface-route &lt;AWS_VPC SUBNET/MASK&gt; next-hop-interface vti0

set vpn ipsec ike-group ikeGroup1
set vpn ipsec ike-group ikeGroup1 lifetime 28800
set vpn ipsec ike-group ikeGroup1 proposal 1 encryption aes128
set vpn ipsec ike-group ikeGroup1 proposal 1 hash sha1 
set vpn ipsec ike-group ikeGroup1 proposal 1 dh-group 2
set vpn ipsec ike-group ikeGroup1 dead-peer-detection action 'restart'
set vpn ipsec ike-group ikeGroup1 dead-peer-detection interval '10'
set vpn ipsec ike-group ikeGroup1 dead-peer-detection timeout '30'

set vpn ipsec esp-group espGroup1
set vpn ipsec esp-group espGroup1 compression disable
set vpn ipsec esp-group espGroup1 mode tunnel
set vpn ipsec esp-group espGroup1 pfs enable
set vpn ipsec esp-group espGroup1 lifetime 3600
set vpn ipsec esp-group espGroup1 proposal 1 encryption aes128
set vpn ipsec esp-group espGroup1 proposal 1 hash sha1

set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; authentication id &lt;YOUR_EXTERNAL_IP&gt;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; authentication mode pre-shared-secret
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; authentication pre-shared-secret &lt;PRE_SHARED_SECRET&gt;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; connection-type initiate
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; default-esp-group espGroup1
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; description &quot;tunnel1&quot;
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; ike-group ikeGroup1
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; local-address &lt;YOUR_EXTERNAL_IP&gt;

set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; vti bind vti0
set vpn ipsec site-to-site peer &lt;AWS PEER IP&gt; vti esp-group espGroup1
set vpn ipsec ipsec-interfaces interface 'eth1' #Assuming your external interface is Eth1
</code></pre>
<p>If you have more questions or need help, feel free to reach out!</p>

		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/networking">networking</a></li>
								
								<li><a href="/tags/aws">aws</a></li>
								
								<li><a href="/tags/vpn">vpn</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> All Content Copyright © - Francis Setash   </div>
	</nav>
</div>




</body>
</html>
